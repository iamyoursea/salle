<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.example.salle.mapper.ChatRoomMapper">
    
    <insert id="addChatRoom" parameterType="com.example.salle.domain.ChatRoom"
    	useGeneratedKeys="true" keyProperty="id">
    	INSERT INTO 
    	chatroom(pr_id, sellerId, buyerId, createdDate, sellerName, buyerName, pr_title, chatReadBuy, chatReadSell)
    	VALUES (#{pr_id}, #{sellerId}, #{buyerId}, #{createdDate}, #{sellerName}, #{buyerName}, #{pr_title}, 1, 1);
    </insert>
    
    <select id="findByEmail" resultType="com.example.salle.domain.ChatList">
    	SELECT *
    	FROM chatroom AS c
    	JOIN product as p
    	ON c.pr_id = p.pr_id
    	WHERE c.sellerid = #{email}
   		OR c.buyerid = #{email};
    </select>
   
    <select id="findByChatId" resultType="com.example.salle.domain.ChatRoom">
    	SELECT *
    	FROM chatroom
    	WHERE PR_ID = #{pr_id} AND
    	(fromid = #{fromid} OR toid = #{fromid});
    </select>

    <select id="getId" resultType="int">
    	SELECT ID
    	FROM chatroom
    	WHERE PR_ID = #{pr_id} AND
    	BUYERID = #{buyerId};
    </select>

    <update id="updateFileName">
    	UPDATE chatroom
    	SET FILENAME = #{fileName}
    	WHERE ID = #{id};
    </update>
   
    <update id="updateChatReadQuery">
    	UPDATE chatroom
    	SET chatread = 1
    	WHERE pr_id = #{pr_id} AND fromid = #{fromid}
    			AND toid=#{toid};
    </update>
   
   <select id="getUnreadMessages" resultType="int">
   		SELECT COUNT(id)
   		FROM chatroom
   		WHERE (SELLERID = #{email} AND CHATREADSELL = 0) OR 
   		(BUYERID = #{email} AND CHATREADBUY = 0);
   </select>

   <select id="getUnreadChatRoom" resultType="int">
   		SELECT id
   		FROM chatroom
   		WHERE (SELLERID = #{email} AND CHATREADSELL = 0) OR 
   		(BUYERID = #{email} AND CHATREADBUY = 0);
   </select>
   
   <update id="insertChatMessage">
   		UPDATE chatroom
   		SET CHATMESSAGE = #{content}, chatread = 0
   		WHERE fromid = #{fromid} AND toid = #{toid};
   </update>
   
   <select id="getAllChatMessages" resultType="com.example.salle.domain.ChatRoom">
   		SELECT fromname, chatMessage, sendtime
   		FROM chatroom
    	WHERE PR_ID = #{pr_id} AND
    	(fromid = #{fromid} OR toid = #{fromid})
    	ORDER BY id ASC;
   </select>
    
    
</mapper>