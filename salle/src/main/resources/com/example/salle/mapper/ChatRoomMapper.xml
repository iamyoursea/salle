<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.example.salle.mapper.chatmessageMapper">
    
    <insert id="insertChatMessage" parameterType="com.example.salle.domain.chatmessage"
    	useGeneratedKeys="true" keyProperty="id">
    	INSERT INTO 
    	chatmessage(pr_id, fromname, toname, fromid, toid, chatmessage, chatread, chatid)
    	VALUES (#{pr_id}, #{fromname}, #{toname}, #{fromid}, #{toid}, #{chatmessage}, 1, #{chatid});
    </insert>

    <select id="getAllChatMessages" resultType="com.example.salle.domain.chatmessage">
   		SELECT fromname, chatMessage, sendtime
   		FROM chatmessage
    	WHERE PR_ID = #{pr_id} AND
    	(fromid = #{fromid} OR toid = #{fromid})
    	ORDER BY id ASC;
   </select>
   
    
    <select id="getAllChatRoom" resultType="com.example.salle.domain.ChatList">
    	SELECT *
    	FROM chatroom
    	WHERE sellerid = #{email}
   		OR buyerid = #{email};
    </select>
   
    <select id="findByChatId" resultType="com.example.salle.domain.chatmessage">
    	SELECT *
    	FROM chatmessage
    	WHERE PR_ID = #{pr_id} AND
    	(fromid = #{fromid} OR toid = #{fromid});
    </select>

    <select id="getId" resultType="int">
    	SELECT ID
    	FROM chatmessage
    	WHERE PR_ID = #{pr_id} AND
    	BUYERID = #{buyerId};
    </select>

    <update id="updateFileName">
    	UPDATE chatmessage
    	SET FILENAME = #{fileName}
    	WHERE ID = #{id};
    </update>
   
    <update id="updateChatReadQuery">
    	UPDATE chatmessage
    	SET chatread = 1
    	WHERE pr_id = #{pr_id} AND fromid = #{fromid}
    			AND toid=#{toid};
    </update>
   
   <select id="getUnreadMessages" resultType="int">
   		SELECT COUNT(id)
   		FROM chatmessage
   		WHERE (SELLERID = #{email} AND CHATREADSELL = 0) OR 
   		(BUYERID = #{email} AND CHATREADBUY = 0);
   </select>
   

    
    
</mapper>